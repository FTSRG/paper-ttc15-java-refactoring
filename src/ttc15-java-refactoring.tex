\documentclass[submission,copyright,creativecommons]{eptcs}
\providecommand{\event}{TTC 2015}
%\usepackage{breakurl} % Not needed if you use pdflatex only.
% this breaks the document in TeXstudio

% TTC additions
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{xspace}
\usepackage{rotating,amsmath,amsfonts,amssymb}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{todonotes}
\usepackage{float}
\usepackage{xcolor}
\usepackage{listings}
\usepackage{framed}

% custom commands
\definecolor{negcolor}{RGB}{223,49,35}
\definecolor{newcolor}{RGB}{43,183,47}
\definecolor{delcolor}{RGB}{59,66,161}
\newcommand{\union}{\cup}
\newcommand{\intersection}{\cap}
\newcommand{\parentheses}[1]{\left(#1\right)}
\newcommand{\op}[2]{\mathrm{#1}\parentheses{#2}}
\newcommand{\figref}[1]{\autoref{fig:#1}}
\newcommand{\lstref}[1]{\autoref{lst:#1}}
\newcommand{\naturaljoin}{\bowtie}
\newcommand{\antijoin}{\, \triangleright \,}
\newcommand{\eiq}{\mbox{\textsc{EMF-IncQuery}}\@\xspace}
\newcommand{\viatra}{\mbox{\textsc{Viatra}}\@\xspace}
\newcommand{\viatratwo}{\mbox{\textsc{Viatra2}}\@\xspace}
\newcommand{\evm}{\mbox{\textsc{Viatra-EVM}}\@\xspace}
\newcommand{\jdt}{\mbox{Eclipse JDT}\@\xspace}
\newcommand{\xtend}{\mbox{Xtend}\@\xspace}

\renewcommand{\sectionautorefname}{Section}
\renewcommand{\subsectionautorefname}{Section}
\renewcommand{\subsubsectionautorefname}{Section}

\newcommand{\ie}{i.e.\@\xspace}
\newcommand{\Ie}{I.e.\@\xspace}
\newcommand{\eg}{e.g.\@\xspace}
\newcommand{\Eg}{E.g.\@\xspace}
\newcommand{\etal}{et al.\@\xspace}
\newcommand{\etc}{etc.\@\xspace}

\newcommand{\ttcfig}[3]{
\begin{figure}[htb] 
	\centering
	\includegraphics[width=#3\textwidth]{figures/#1}
	\caption{#2.}
	\label{fig:#1}
\end{figure}}

\newcommand{\ttcpattern}[1]{
\begin{figure}[H] 
	\centering
	\includegraphics[scale=0.3]{figures/#1}
\end{figure}}

\newcommand{\ttcfigscale}[3]{
\begin{figure}[htb]
	\centering
	\includegraphics[scale=#3]{figures/#1}
	\caption{#2.}
	\label{fig:#1}
\end{figure}}

\newcommand{\ttcsubfig}[2]{
	\begin{subfigure}[b]{\textwidth}
		\centering
		\includegraphics[scale=0.6]{figures/#1}
		\caption{#2}
		\label{fig:#1}
	\end{subfigure}
}

\definecolor{lightgray}{rgb}{0.95,0.95,0.95}
\lstset{
	basicstyle=\scriptsize\ttfamily, % print whole listing small
	keywordstyle=\color{black}\bfseries, % bold black keywords
	identifierstyle=, % nothing happens
	commentstyle=\color{green}, % green comments
	stringstyle=\scriptsize,
	showstringspaces=false, % no special string spaces
	aboveskip=3pt,
	belowskip=3pt,
	backgroundcolor=\color{lightgray},
	columns=flexible,
	keepspaces=true
} 


\usepackage{color}
\definecolor{listinggray}{rgb}{0.92,0.92,0.92}
\definecolor{keywordcolor}{rgb}{0.5,0,0.1}
\definecolor{commentcolor}{rgb}{0,0.3,0.1}
\definecolor{stringcolor}{rgb}{0,0,1}
\lstdefinelanguage{IQPL}
{morekeywords={@QueryBasedFeature,@Constraint,count,pattern,package,
    neg,find,import,true,false,or,check,job,action,state,severity,location,message,
    oclIsKindOf,self,exists,includes,invariant,class},
 sensitive=true, morecomment=[l]{//}, morecomment=[s]{/*}{*/},
 morestring=[b]{"},
}
\newcommand{\listingiqpl}[1]
{
\lstset{backgroundcolor=\color{listinggray}}
\lstset{basicstyle=\scriptsize\ttfamily}
\lstset{commentstyle=\color{commentcolor}\ttfamily}
\lstset{stringstyle=\color{stringcolor}\ttfamily}
\lstset{frameround=tttt}
\lstset{captionpos=b}
\lstset{keywordstyle=\color{keywordcolor}\bfseries\ttfamily}
\lstset{showstringspaces=false}
\lstset{tabsize=2}
\lstset{numbers=left,numberstyle=\scriptsize\ttfamily,stepnumber=1,numbersep=5pt}
\lstset{language=IQPL}
\lstset{escapeinside={(*@}{@*)}}
\lstset{breaklines=true}
\lstinputlisting{#1}
}

\lstdefinelanguage{Xtend}{
 morekeywords={class,public,def,val,var,cached,case,default,extension,false,import,JAVA,WORKFLOWSLOT,let,new,null,private,create,switch,this,true,reexport,around,if,then,else,context,DEFAULT_NO_UPDATE_AND_DISAPPEAR,DEFAULT,APPEARED,DISAPPEARED,UPDATED,processor},
 keywordstyle=[2]{\textbf},
 morecomment=[l]{//}, 
 morecomment=[s]{/*}{*/}, 
 morestring=[b]",
 tabsize=2
}
\newcommand{\listingxtend}[1]{
%\lstset{backgroundcolor=\color{listinggray}}
\lstset{basicstyle=\scriptsize\ttfamily}
\lstset{numbers=left,numberstyle=\tiny\ttfamily,stepnumber=1,numbersep=5pt}
\lstset{commentstyle=\color{commentcolor}\ttfamily}
\lstset{stringstyle=\color{stringcolor}\ttfamily}
\lstset{keywordstyle=\color{keywordcolor}\bfseries\ttfamily}
\lstset{breaklines=true}
\lstset{language=Xtend}
\lstset{mathescape=true}
\lstset{basicstyle=\scriptsize\ttfamily}
\lstset{escapeinside={(*@}{@*)}}
\lstset{literate=*{[guilleft]}{\guillemotleft{}}{1}{[guilright]}{\guillemotright{}}{1},}

%\lstset{literate={\-}{}{0\discretionary{-}{}{}}}
\lstinputlisting{#1}
}

% metadata
\title{Java Refactoring Case: a \viatra Solution\thanks{This work was partially supported by the MONDO (EU ICT-611125) project.}}
\author{D\'{a}niel Stein \qquad G\'{a}bor Sz\'{a}rnyas \qquad \'{A}bel Heged\"{u}s \qquad Istv\'{a}n R\'{a}th
\institute{Budapest University of Technology and Economics\\
Department of Measurement and Information Systems\\
H-1117 Magyar tud\'{o}sok krt. 2, Budapest, Hungary}
\email{daniel.stein@inf.mit.bme.hu, \{szarnyas, abel.hegedus, rath\}@mit.bme.hu}
}
\def\titlerunning{Java Refactoring Case: a VIATRA Solution}
\def\authorrunning{D. Stein et al.}

\begin{document}
\maketitle

\begin{abstract}
This paper presents a solution for the Java Refactoring Case of the Transformation Tool Contest 2015. The solution utilises \jdt for creating the program graph; while \eiq, \viatra and the \xtend programming language are used for defining and performing the model transformations.
\end{abstract}

\section{Introduction}

The use of automated model transformations is a key factor in modern model-driven system engineering. Model transformations allow to query, derive and manipulate large industrial models, including models based on existing systems, e.g. source code models created with reverse engineering techniques. Since such transformations are frequently integrated to modeling environments, they need to feature both high performance and a concise programming interface to support software engineers.

Refactoring operations are often used in software engineering to improve the readability, maintainability of existing source code without altering the behaviour of the software.

\subsection{\eiq}

Automated model transformations are frequently integrated to modeling environments, requiring both high performance and a concise programming interface to support software engineers. The objective of the \eiq\cite{eiq-homepage} framework is to provide a declarative way to define queries over EMF models. \eiq extended the pattern language of \viatratwo with new features (including transitive closure, role navigation, match count) and tailored it to EMF models~\cite{iqpl}. \eiq is developed with a focus on \emph{incremental query evaluation}. 

\subsection{\viatra}

The \viatra framework supports the development of model transformations with specific focus on event-driven, reactive transformations~\cite{viatra}. Building upon the incremental query support of the \eiq project, \viatra offers a language to define transformations and a reactive transformation engine to execute certain transformations upon changes in the underlying model.

The \viatra project provides:

\begin{itemize}
	\item An internal DSL over the \xtend~\cite{Xtend} language to specify both batch and event-driven, reactive transformations.
	\item A complex event-processing engine over EMF models to specify reactions upon detecting complex sequences of events.
	\item A rule-based design space exploration framework to explore design candidates as models satisfying multiple criteria.
	\item A model obfuscator to remove sensitive information from a confidential model (\eg to create bug reports).
\end{itemize}

The current \viatra{} project is a full rewrite of the previous \viatratwo{} framework, now with full compatibility and support for EMF models. The history of the \viatra{} family is described in~\cite{viatra-history}.

\section{Case Description}

The goal of the Java Refactoring Case~\cite{ttc-refactoring-case} is to use model transformation tools to perform refactoring operations on Java source code. The main challenges of the case are the following:

\begin{enumerate}
\item Transform the \emph{Java source code} to a \emph{program graph} (PG). The source code and the program graph must be synchronised using a bidirectional transformation.
\item Perform the refactoring transformation on the program graph.
\end{enumerate}

The source code is defined in a restricted sub-language of Java 1.4. The EMF metamodel of the PG is provided in the case description. The case considers two refactoring operations:

\begin{itemize}
\item \textsf{Pull Up Method}
\item \textsf{Create Superclass}
\end{itemize}

\section{Implementation}

The source code of the solution is available as an open-source project.\footnote{\url{https://github.com/FTSRG/java-refactoring-ttc-viatra}}

The solution was developed in the Eclipse IDE. For setting up the development environment, please refer to the readme file. The projects are not tied to the Eclipse environment and can be compiled with the Apache Maven~\cite{Maven} build automation tool. This offers a number of benefits, including easy portability and the possibility of continuous integration.

The solution is written in Java~8 and Xtend~\cite{Xtend}.

\todo[inline]{ide kellene egy abra sorszamokkal, amikre lehet hivatkozni a kovetkezokben}

\subsection{Parsing the Source Code to the ASG}

The solution uses the parser of Eclipse Java Development Tools~\cite{jdt}, which is also used in the Eclipse Java IDE. The parser generates the Abstract Syntax Graph (ASG) from the provided source code files.

\ttcfig{pg}{Caption}{0.6}

\ttcfig{trace-mm}{Metamodel of the trace model}{0.6}

\subsection{Synchronising the ASG and the PG}

As \viatra does not support bidirectional transformations, the JDT ASG--PG transformation was implemented as two separate transformations:

\begin{description}
\item[JDT ASG to PG] The JDT model is traversed using the Visitor pattern.
\item[PG to JDT ASG] \viatra rules are used to detect the changes and execute the appropriate actions to keep the ASG in sync.
\end{description}

\subsection{Transforming the PG}

The refactoring operations are implemented as model transformations on the PG. Each model transformation is defined in \viatra: the LHS is defined with an \eiq pattern and the RHS is defined with an imperative Xtend code.

\section{Evaluation}

The benchmark were conducted on a 64-bit Arch Linux virtual machine running on SHARE.\footnote{\url{https://is.ieis.tue.nl/staff/pvgorp/share/}}

\ttcfig{benchmark-results}{Benchmark results}{0.8}

\section{Summary}

The paper presented a solution for the Java Refactoring case of the 2015 Transformation Tool Contest. The solution addresses both challenges (bidirectional synchrosiation and program refactoring) and both refactoring operations (pull up method, create superclass) defined in the case.

The framework is flexible to allow the user to define new refactoring operations, \eg \textsf{Extract Class} or \textsf{Pull Up Field}.

\bibliographystyle{eptcs}
\bibliography{ttc}

\clearpage

\appendix
\section{Appendix}

\listingxtend{code/transformation.xtend}

\listingiqpl{code/pattern.eiq}

\end{document}
